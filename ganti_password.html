<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ganti Password</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body{background:#f4f6fb;}
    .wrap{
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:1rem;
    }
    .card{
      max-width:420px;
      width:100%;
      border-radius:1rem;
      box-shadow:0 10px 25px rgba(0,0,0,.08);
    }
  </style>
</head>
<body>
<div class="wrap">
  <div class="card p-4">
    <h5 class="mb-3 text-center">Ganti Password</h5>

    <form id="form-change-pass">
      <div class="mb-3">
        <label class="form-label">Password Lama</label>
        <input type="password" id="old-pass" class="form-control" required>
      </div>

      <div class="mb-3">
        <label class="form-label">Password Baru</label>
        <input type="password" id="new-pass" class="form-control" required>
      </div>

      <div class="mb-3">
        <label class="form-label">Konfirmasi Password</label>
        <input type="password" id="confirm-pass" class="form-control" required>
      </div>

      <button class="btn btn-primary w-100" type="submit">Update Password</button>
    </form>

    <div class="text-center mt-3">
      <a href="index.html" class="small">Kembali ke dashboard</a>
    </div>
  </div>
</div>

<script type="module">
  import { firebaseConfig } from './script/firebase-config.js';
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js';
  import { getDatabase, ref, get, update } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js';

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // HASH SHA-256
  async function sha256(text) {
    const encoder = new TextEncoder();
    const data = encoder.encode(text);
    const hashBuffer = await crypto.subtle.digest("SHA-256", data);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(b => b.toString(16).padStart(2,'0')).join('');
  }

  // Ambil session login yang BENAR
  const currentUser = localStorage.getItem('app_current');  // FIX

  if(!currentUser){
    alert('Silakan login terlebih dahulu');
    location.href = 'login.html';
  }

  document.getElementById('form-change-pass').addEventListener('submit', async (e) => {
    e.preventDefault();

    const oldp = document.getElementById('old-pass').value;
    const newp = document.getElementById('new-pass').value;
    const conf = document.getElementById('confirm-pass').value;

    if(newp !== conf){
      return alert('Konfirmasi password tidak cocok');
    }

    try {
      // Ambil data user dari Firebase
      const userRef = ref(db, 'users/' + currentUser);
      const snap = await get(userRef);

      if(!snap.exists()){
        return alert('User tidak ditemukan');
      }

      const data = snap.val();

      // HASH input password lama & baru
      const oldpHash = await sha256(oldp);
      const newpHash = await sha256(newp);

      // COCOKKAN DENGAN FIELD YANG BENAR (password)
      if(data.password !== oldpHash){
        return alert('Password lama salah');
      }

      // UPDATE ke field yg benar: password
      await update(userRef, { password: newpHash });

      alert('Password berhasil diperbarui');
      document.getElementById('form-change-pass').reset();

    } catch(err) {
      console.error(err);
      alert('Gagal memperbarui password');
    }
  });
</script>



<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kelola User — Agenda Surat Digital (Firebase)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root{ --maxw:1100px; }
    body{ background:#f7f9fc; }
    .container{ max-width:var(--maxw); }
    .toast-fixed{ position:fixed; right:16px; bottom:16px; z-index:1050; }
    .table-wrap{ max-height:55vh; overflow:auto; }
    @media (max-width:576px){
      .form-grid{ flex-direction:column; gap:.6rem; }
    }
  </style>
</head>
<body>
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="m-0">Kelola User</h4>
    <div>
      <button class="btn btn-sm btn-secondary" onclick="location.href='index.html'">Dasboard</button>
    </div>
  </div>

  <div class="card mb-3">
    <div class="card-body">
      <form id="form-add-user" class="d-flex form-grid gap-2 align-items-start flex-wrap">
        <input id="username" class="form-control" placeholder="Username (unik)" required>
        <input id="name" class="form-control" placeholder="Nama lengkap" required>
        <input id="password" class="form-control" placeholder="Password" required>
        <select id="role" class="form-select" style="min-width:120px">
          <option value="user">User</option>
          <option value="admin">Admin</option>
        </select>
        <button class="btn btn-success" type="submit">Tambah / Simpan</button>
      </form>
      
    </div>
  </div>

  <div class="card">
    <div class="card-body">
      <h6 class="card-title">Daftar User</h6>
      <div class="table-wrap">
        <table class="table table-sm table-hover">
          <thead>
            <tr>
              <th>Username</th>
              <th>Nama</th>
              <th>Role</th>
              <th>Dibuat</th>
              <th class="text-end">Aksi</th>
            </tr>
          </thead>
          <tbody id="user-table-body"></tbody>
        </table>
      </div>
    </div>
  </div>

</div>

<!-- Edit Modal -->
<div class="modal fade" id="modalEdit" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="form-edit-user">
        <div class="modal-header">
          <h5 class="modal-title">Edit User</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input id="edit-username" class="form-control mb-2" readonly>
          <input id="edit-name" class="form-control mb-2" placeholder="Nama lengkap" required>
          <input id="edit-password" class="form-control mb-2" placeholder="Password (kosongkan bila tidak ganti)">
          <select id="edit-role" class="form-select">
            <option value="user">User</option>
            <option value="admin">Admin</option>
          </select>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
          <button class="btn btn-primary" type="submit">Simpan Perubahan</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Toasts container -->
<div class="toast-fixed" id="toast-container"></div>

<script type="module">
  // HANYA import config — Firebase SUDAH di initialize di firebase-config.js
import "./script/firebase-config.js";

// Import Realtime Database
import { 
  getDatabase, 
  ref, 
  get 
} from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

// Ambil DB instance
import { db } from "./script/firebase-config.js";

  // init
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // UI refs
  const formAdd = document.getElementById('form-add-user');
  const tbody = document.getElementById('user-table-body');
  const toastContainer = document.getElementById('toast-container');

  const modalEditEl = document.getElementById('modalEdit');
  const bsModal = new bootstrap.Modal(modalEditEl);
  const formEdit = document.getElementById('form-edit-user');

  // SHA256 function (added for hashing passwords)
  async function sha256(message) {
    const msgBuffer = new TextEncoder().encode(message);
    const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(b => b.toString(16).padStart(2,'0')).join('');
  }

  // Listen for DB changes and render
  const usersRef = ref(db, 'users');
  onValue(usersRef, snapshot => {
    const data = snapshot.val() || {};
    renderUsers(data);
  });

  formAdd.addEventListener('submit', async (e) => {
    e.preventDefault();
    const username = document.getElementById('username').value.trim();
    const name = document.getElementById('name').value.trim();
    const password = document.getElementById('password').value;
    const role = document.getElementById('role').value;

    if (!username || !name || !password) return showToast('Lengkapi semua field');

    // check if username exists
    const snap = await get(child(ref(db), 'users/' + username));
    if (snap.exists()) return showToast('Username sudah ada');

    const hashed = await sha256(password);  // Modified: Hash password

    await set(ref(db, 'users/' + username), {
      name, password: hashed, role, createdAt: Date.now()  // Modified: Use 'pass' field
    });

    formAdd.reset();
    showToast('User ditambahkan');
  });

  function renderUsers(users) {
    tbody.innerHTML = '';
    const keys = Object.keys(users).sort((a,b)=> (users[a].createdAt||0) - (users[b].createdAt||0));
    if (keys.length === 0) {
      tbody.innerHTML = '<tr><td colspan="5" class="text-center small text-muted">Belum ada user</td></tr>';
      return;
    }
    keys.forEach(u => {
      const it = users[u];
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${escapeHtml(u)}</td>
        <td>${escapeHtml(it.name || '')}</td>
        <td>${escapeHtml(it.role || '')}</td>
        <td>${it.createdAt ? new Date(it.createdAt).toLocaleString() : '-'}</td>
        <td class="text-end">
          <button class="btn btn-sm btn-primary me-1" data-username="${encodeURIComponent(u)}" onclick="window.__editUser('${u}')">Edit</button>
          <button class="btn btn-sm btn-danger" onclick="window.__deleteUser('${u}')">Hapus</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  // attach functions to window so buttons can call them
  window.__editUser = async (username) => {
    const snap = await get(ref(db, 'users/' + username));
    if (!snap.exists()) return showToast('User tidak ditemukan');
    const data = snap.val();
    document.getElementById('edit-username').value = username;
    document.getElementById('edit-name').value = data.name || '';
    document.getElementById('edit-password').value = '';
    document.getElementById('edit-role').value = data.role || 'user';
    bsModal.show();
  };

  formEdit.addEventListener('submit', async (e) => {
    e.preventDefault();
    const username = document.getElementById('edit-username').value;
    const name = document.getElementById('edit-name').value.trim();
    const password = document.getElementById('edit-password').value;
    const role = document.getElementById('edit-role').value;
    if (!name) return showToast('Nama tidak boleh kosong');

    const updates = { name, role };
    if (password) {
      const hashed = await sha256(password);  // Modified: Hash if provided
      updates.pass = hashed;
    }

    await update(ref(db, 'users/' + username), updates);
    bsModal.hide();
    showToast('Perubahan disimpan');
  });

  window.__deleteUser = async (username) => {
    if (!confirm('Hapus user ' + username + '?')) return;
    await remove(ref(db, 'users/' + username));
    showToast('User dihapus');
  };

  // small helpers
  function showToast(msg, timeout=2200){
    const el = document.createElement('div');
    el.className = 'toast align-items-center show mb-2';
    el.setAttribute('role','alert');
    el.innerHTML = `<div class="d-flex"><div class="toast-body">${escapeHtml(msg)}</div><button type="button" class="btn-close btn-close-white ms-2 me-1" aria-label="Close"></button></div>`;
    toastContainer.appendChild(el);
    el.querySelector('.btn-close').addEventListener('click', ()=> el.remove());
    setTimeout(()=> el.remove(), timeout);
  }

  function escapeHtml(s){ return (s+'').replace(/[&<>\"']/g, (c)=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
